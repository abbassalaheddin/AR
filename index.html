<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v7.0.0/dist/aframe-extras.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
    <script>
      // ============================================
      // ONE EURO FILTER - Best for AR tracking
      // ============================================
      class OneEuroFilter {
        constructor(minCutoff = 1.0, beta = 0.007, dcutoff = 1.0) {
          this.minCutoff = minCutoff;
          this.beta = beta;
          this.dcutoff = dcutoff;
          this.x = null;
          this.dx = 0;
          this.lastTime = null;
        }

        filter(value, timestamp) {
          if (this.lastTime === null) {
            this.lastTime = timestamp;
            this.x = value;
            return value;
          }

          const dt = timestamp - this.lastTime;
          if (dt <= 0) return this.x;

          // Calculate derivative
          const edvalue = (value - this.x) / dt;
          this.dx = this.lowpass(edvalue, this.dx, this.alpha(dt, this.dcutoff));

          // Adaptive cutoff based on velocity
          const cutoff = this.minCutoff + this.beta * Math.abs(this.dx);
          const result = this.lowpass(value, this.x, this.alpha(dt, cutoff));

          this.x = result;
          this.lastTime = timestamp;
          return result;
        }

        alpha(dt, cutoff) {
          const tau = 1.0 / (2 * Math.PI * cutoff);
          return 1.0 / (1.0 + tau / dt);
        }

        lowpass(value, prev, alpha) {
          return prev + alpha * (value - prev);
        }

        reset() {
          this.x = null;
          this.dx = 0;
          this.lastTime = null;
        }
      }

      // ============================================
      // VECTOR ONE EURO FILTER
      // ============================================
      class VectorOneEuroFilter {
        constructor(minCutoff = 1.0, beta = 0.007) {
          this.filters = {
            x: new OneEuroFilter(minCutoff, beta),
            y: new OneEuroFilter(minCutoff, beta),
            z: new OneEuroFilter(minCutoff, beta)
          };
        }

        filter(vector, timestamp) {
          return new THREE.Vector3(
            this.filters.x.filter(vector.x, timestamp),
            this.filters.y.filter(vector.y, timestamp),
            this.filters.z.filter(vector.z, timestamp)
          );
        }

        reset() {
          this.filters.x.reset();
          this.filters.y.reset();
          this.filters.z.reset();
        }
      }

      // ============================================
      // SMART AR STABILIZER - Motion Aware
      // ============================================
      AFRAME.registerComponent('smart-stabilizer', {
        schema: {
          enabled: { type: 'boolean', default: true },
          minCutoff: { type: 'number', default: 0.5 },  // Lower = more smoothing
          beta: { type: 'number', default: 0.5 },        // Higher = faster response to motion
          rotationSmoothing: { type: 'number', default: 0.3 }
        },

        init: function() {
          this.targetEntity = this.el;
          this.isTracking = false;
          this.wasTracking = false;
          
          // One Euro Filters for position (best for AR)
          this.positionFilter = new VectorOneEuroFilter(
            this.data.minCutoff,
            this.data.beta
          );
          
          // Smooth rotation with SLERP
          this.smoothRotation = new THREE.Quaternion();
          this.targetRotation = new THREE.Quaternion();
          
          // Last valid pose for lost tracking
          this.lastValidPose = {
            position: new THREE.Vector3(),
            rotation: new THREE.Quaternion()
          };
          
          // Tracking events
          this.targetEntity.addEventListener('targetFound', () => {
            this.isTracking = true;
            if (!this.wasTracking) {
              // Just found - reset filters to prevent jump
              this.positionFilter.reset();
              const pos = this.targetEntity.object3D.position;
              this.lastValidPose.position.copy(pos);
              this.wasTracking = true;
            }
          });

          this.targetEntity.addEventListener('targetLost', () => {
            this.isTracking = false;
          });

          this.startTime = performance.now();
        },

        tick: function(time, deltaTime) {
          if (!this.targetEntity.object3D || !this.data.enabled) return;

          const obj3D = this.targetEntity.object3D;
          const timestamp = (performance.now() - this.startTime) / 1000;
          
          if (this.isTracking) {
            // Get raw tracked position from MindAR
            const rawPos = obj3D.position.clone();
            const rawRot = obj3D.quaternion.clone();
            
            // Apply One Euro Filter (automatically adapts to velocity)
            const filteredPos = this.positionFilter.filter(rawPos, timestamp);
            
            // Smooth rotation with SLERP
            this.smoothRotation.slerp(rawRot, this.data.rotationSmoothing);
            
            // Apply filtered transforms
            obj3D.position.copy(filteredPos);
            obj3D.quaternion.copy(this.smoothRotation);
            
            // Save for lost tracking
            this.lastValidPose.position.copy(filteredPos);
            this.lastValidPose.rotation.copy(this.smoothRotation);
            
            this.wasTracking = true;
            
          } else if (this.wasTracking) {
            // Lost tracking - freeze at last known position
            obj3D.position.copy(this.lastValidPose.position);
            obj3D.quaternion.copy(this.lastValidPose.rotation);
          }
        }
      });

      // ============================================
      // SMOOTH VISIBILITY (fade in/out)
      // ============================================
      AFRAME.registerComponent('smooth-visibility', {
        schema: {
          fadeTime: { type: 'number', default: 150 }
        },

        init: function() {
          this.targetOpacity = 0;
          this.currentOpacity = 0;
          
          this.materials = [];
          this.el.object3D.traverse((node) => {
            if (node.material) {
              if (Array.isArray(node.material)) {
                this.materials.push(...node.material);
              } else {
                this.materials.push(node.material);
              }
            }
          });
          
          this.materials.forEach(mat => {
            mat.transparent = true;
            mat.opacity = 0;
          });

          this.el.addEventListener('targetFound', () => {
            this.targetOpacity = 1;
          });

          this.el.addEventListener('targetLost', () => {
            this.targetOpacity = 0;
          });
        },

        tick: function(time, deltaTime) {
          if (this.currentOpacity === this.targetOpacity) return;
          
          const speed = 1000 / this.data.fadeTime;
          const delta = deltaTime * speed;
          
          if (this.currentOpacity < this.targetOpacity) {
            this.currentOpacity = Math.min(this.currentOpacity + delta, this.targetOpacity);
          } else {
            this.currentOpacity = Math.max(this.currentOpacity - delta, this.targetOpacity);
          }
          
          this.materials.forEach(mat => {
            mat.opacity = this.currentOpacity;
          });
        }
      });

      // ============================================
      // DEBUG INFO
      // ============================================
      AFRAME.registerComponent('debug-info', {
        init: function() {
          this.debugEl = document.getElementById('debug-info');
          this.isTracking = false;
          
          this.el.addEventListener('targetFound', () => {
            this.isTracking = true;
          });
          
          this.el.addEventListener('targetLost', () => {
            this.isTracking = false;
          });
        },

        tick: function() {
          if (this.debugEl) {
            const status = this.isTracking ? 
              '<span style="color: #4ade80">‚óè TRACKING</span>' : 
              '<span style="color: #f87171">‚óè LOST</span>';
            this.debugEl.innerHTML = status;
          }
        }
      });

    </script>
    <style>
      #info-panel {
        position: fixed;
        top: 10px;
        left: 10px;
        background: rgba(0,0,0,0.85);
        color: white;
        padding: 12px 16px;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        font-size: 13px;
        border-radius: 8px;
        z-index: 1000;
        box-shadow: 0 4px 6px rgba(0,0,0,0.3);
      }
      #info-panel div {
        margin: 4px 0;
      }
    </style>
  </head>
  <body>
    <a-scene 
      mindar-image="imageTargetSrc: https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/examples/image-tracking/assets/band-example/band.mind; maxTrack: 2; warmupTolerance: 0; missTolerance: 0;" 
      color-space="sRGB" 
      renderer="colorManagement: true, physicallyCorrectLights, antialias: true" 
      vr-mode-ui="enabled: false" 
      device-orientation-permission-ui="enabled: false">
      
      <a-assets>
        <a-asset-item id="bearModel" src="https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/examples/image-tracking/assets/band-example/bear/scene.gltf"></a-asset-item>
        <a-asset-item id="raccoonModel" src="https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/examples/image-tracking/assets/band-example/raccoon/scene.gltf"></a-asset-item>
      </a-assets>

      <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

      <!-- RACCOON with Smart Stabilization -->
      <a-entity 
        mindar-image-target="targetIndex: 0"
        smart-stabilizer="enabled: true; minCutoff: 0.5; beta: 0.5; rotationSmoothing: 0.3"
        debug-info>
        <a-gltf-model 
          rotation="0 0 0" 
          position="0 -0.25 0" 
          scale="0.05 0.05 0.05" 
          src="#raccoonModel" 
          animation-mixer
          smooth-visibility="fadeTime: 150">
        </a-gltf-model>
      </a-entity>

      <!-- BEAR with Smart Stabilization -->
      <a-entity 
        mindar-image-target="targetIndex: 1"
        smart-stabilizer="enabled: true; minCutoff: 0.5; beta: 0.5; rotationSmoothing: 0.3">
        <a-gltf-model 
          rotation="0 0 0" 
          position="0 -0.25 0" 
          scale="0.05 0.05 0.05" 
          src="#bearModel" 
          animation-mixer
          smooth-visibility="fadeTime: 150">
        </a-gltf-model>
      </a-entity>
    </a-scene>

    <div id="info-panel">
      <div><strong>üéØ AR Stabilizer v2</strong></div>
      <div id="debug-info">‚óè Initializing...</div>
      <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.2); font-size: 11px; opacity: 0.7;">
        One Euro Filter Active
      </div>
    </div>
  </body>
</html>