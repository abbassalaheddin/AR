<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v7.0.0/dist/aframe-extras.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
    <script>
      // ============================================
      // MINIMAL JITTER REDUCTION
      // Only smooth high-frequency noise, not real motion
      // ============================================
      AFRAME.registerComponent('jitter-filter', {
        schema: {
          strength: { type: 'number', default: 0.7 }  // 0-1, how much to smooth
        },

        init: function() {
          this.smoothPos = new THREE.Vector3();
          this.smoothRot = new THREE.Quaternion();
          this.isFirstFrame = true;
          this.isTracking = false;
          
          this.el.addEventListener('targetFound', () => {
            this.isTracking = true;
            this.isFirstFrame = true;
          });
          
          this.el.addEventListener('targetLost', () => {
            this.isTracking = false;
          });
        },

        tick: function(time, deltaTime) {
          if (!this.isTracking || !this.el.object3D) return;
          
          const obj = this.el.object3D;
          const rawPos = obj.position.clone();
          const rawRot = obj.quaternion.clone();
          
          if (this.isFirstFrame) {
            // First frame after tracking found - no smoothing
            this.smoothPos.copy(rawPos);
            this.smoothRot.copy(rawRot);
            this.isFirstFrame = false;
          } else {
            // Calculate distance moved
            const distance = this.smoothPos.distanceTo(rawPos);
            
            // Adaptive smoothing based on distance
            // Big movements = less smoothing (follow fast)
            // Small movements = more smoothing (kill jitter)
            let alpha;
            if (distance > 0.1) {
              alpha = 0.8;  // Fast follow for large movements
            } else if (distance > 0.05) {
              alpha = 0.5;  // Medium
            } else {
              alpha = 0.2;  // Heavy smoothing for tiny jitters
            }
            
            // Apply exponential smoothing
            this.smoothPos.lerp(rawPos, alpha);
            this.smoothRot.slerp(rawRot, alpha);
          }
          
          obj.position.copy(this.smoothPos);
          obj.quaternion.copy(this.smoothRot);
        }
      });

      // ============================================
      // SMOOTH FADE IN/OUT
      // ============================================
      AFRAME.registerComponent('fade-visibility', {
        schema: {
          duration: { type: 'number', default: 200 }
        },

        init: function() {
          this.opacity = 0;
          this.targetOpacity = 0;
          this.materials = [];
          
          // Get all materials
          this.el.addEventListener('model-loaded', () => {
            this.el.object3D.traverse((node) => {
              if (node.material) {
                const mats = Array.isArray(node.material) ? node.material : [node.material];
                mats.forEach(mat => {
                  mat.transparent = true;
                  mat.opacity = 0;
                  this.materials.push(mat);
                });
              }
            });
          });
          
          this.el.addEventListener('targetFound', () => {
            this.targetOpacity = 1;
          });
          
          this.el.addEventListener('targetLost', () => {
            this.targetOpacity = 0;
          });
        },

        tick: function(time, deltaTime) {
          if (this.opacity === this.targetOpacity) return;
          
          const step = (deltaTime / this.data.duration);
          
          if (this.opacity < this.targetOpacity) {
            this.opacity = Math.min(this.opacity + step, 1);
          } else {
            this.opacity = Math.max(this.opacity - step, 0);
          }
          
          this.materials.forEach(mat => {
            mat.opacity = this.opacity;
          });
        }
      });

      // ============================================
      // DEBUG STATUS
      // ============================================
      AFRAME.registerComponent('track-status', {
        init: function() {
          this.statusEl = document.getElementById('status');
          this.isTracking = false;
          
          this.el.addEventListener('targetFound', () => {
            this.isTracking = true;
            if (this.statusEl) {
              this.statusEl.innerHTML = '<span style="color: #4ade80">● TRACKING</span>';
            }
          });
          
          this.el.addEventListener('targetLost', () => {
            this.isTracking = false;
            if (this.statusEl) {
              this.statusEl.innerHTML = '<span style="color: #f87171">● LOST</span>';
            }
          });
        }
      });
    </script>
    <style>
      body { margin: 0; overflow: hidden; }
      #overlay {
        position: fixed;
        top: 10px;
        left: 10px;
        background: rgba(0,0,0,0.8);
        color: white;
        padding: 10px 15px;
        border-radius: 8px;
        font-family: -apple-system, sans-serif;
        font-size: 14px;
        z-index: 9999;
      }
    </style>
  </head>
  <body>
    <a-scene 
      mindar-image="imageTargetSrc: https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/examples/image-tracking/assets/band-example/band.mind; filterMinCF: 0.001; filterBeta: 10; maxTrack: 2" 
      color-space="sRGB" 
      renderer="colorManagement: true, physicallyCorrectLights, antialias: true, alpha: true" 
      vr-mode-ui="enabled: false" 
      device-orientation-permission-ui="enabled: false">
      
      <a-assets>
        <a-asset-item id="bearModel" src="https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/examples/image-tracking/assets/band-example/bear/scene.gltf"></a-asset-item>
        <a-asset-item id="raccoonModel" src="https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/examples/image-tracking/assets/band-example/raccoon/scene.gltf"></a-asset-item>
      </a-assets>

      <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

      <!-- RACCOON -->
      <a-entity 
        mindar-image-target="targetIndex: 0"
        jitter-filter="strength: 0.7"
        track-status>
        <a-gltf-model 
          rotation="0 0 0" 
          position="0 -0.25 0" 
          scale="0.05 0.05 0.05" 
          src="#raccoonModel" 
          animation-mixer
          fade-visibility="duration: 200">
        </a-gltf-model>
      </a-entity>

      <!-- BEAR -->
      <a-entity 
        mindar-image-target="targetIndex: 1"
        jitter-filter="strength: 0.7">
        <a-gltf-model 
          rotation="0 0 0" 
          position="0 -0.25 0" 
          scale="0.05 0.05 0.05" 
          src="#bearModel" 
          animation-mixer
          fade-visibility="duration: 200">
        </a-gltf-model>
      </a-entity>
    </a-scene>

    <div id="overlay">
      <div id="status">● Initializing...</div>
      <div style="font-size: 11px; margin-top: 5px; opacity: 0.6;">Light Jitter Filter</div>
    </div>
  </body>
</html>